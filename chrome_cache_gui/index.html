<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Cache-Control" content="no-cache">
    <title>Chrome Cache GUI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" media="screen" href="./css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="./css/main.css" />
    <script src="./js/main.js"></script>
    <script src="./js/image_info.js"></script>
    <script>
        function onLoadImageButtonClicked(){
            listImages(images_index,LOAD_COUNT,document.querySelector('#cache-dir').value,{
                height:parseInt(document.querySelector('#height').value||'0'),
                width:parseInt(document.querySelector('#width').value||'0'),
                query:document.querySelector('#query').value,
                use_regex:document.querySelector('#use-regex').checked,
                operator:document.querySelector('#operator-and').checked?'and':'or',
            });
        }
    </script>
</head>

<body>
    <!-- <button class="btn btn-secondary" style="position: fixed;top:10px;right:10px;z-index: 100;" onclick="exit_app();">Close</button> -->
    <div id="search-box" class="container">
        <h1>Chrome Cache GUI</h1>
        <div class="input-group" style="margin-top:10px;">
            <input type="text" id="cache-dir" class="form-control" placeholder="Chrome Cache Directory" value="">
        </div>
        <div class="input-group" style="margin-top:10px;">
            <input type="text" id="outputdir" class="form-control" placeholder="Output Directory" value="">
        </div>
        <div class="input-group" style="margin-top:10px;">
            <input type="text" id="query" class="form-control" placeholder="Search URL" value="">
        </div>
        <div class="input-group" style="margin-top:10px;">
            <div class="custom-control custom-checkbox">
                <input type="checkbox" class="custom-control-input" id="use-regex">
                <label class="custom-control-label" for="use-regex">Use Regex</label>
            </div>
        </div>
        <div class="input-group" style="margin-top:10px;">
            <input type="text" id="height" class="form-control" placeholder="Height" value="">
            <input type="text" id="width" class="form-control" placeholder="Width" value="">
        </div>
        <div class="input-group" style="margin-top:10px; ">
            <div class="custom-control custom-radio" style="margin-right: 10px;">
                <input type="radio" class="custom-control-input" id="operator-and" name="operator" checked>
                <label class="custom-control-label" for="operator-and">AND</label>
            </div>
            <div class="custom-control custom-radio">
                <input type="radio" class="custom-control-input" id="operator-or" name="operator">
                <label class="custom-control-label" for="operator-or">OR</label>
            </div>
        </div>
        <div class="input-group" style="margin-top:10px;">
            <button class="form-control btn btn-success" onclick="onLoadImageButtonClicked();">Search Images</button>
            <button class="form-control btn btn-info" onclick="saveAllImages();">Save All</button>
        </div>
        <div class="input-group" style="margin-top:10px;">
            <div class="custom-control custom-checkbox">
                <input type="checkbox" class="custom-control-input" id="random-name">
                <label class="custom-control-label" for="random-name">Random Name</label>
            </div>
        </div>
    </div>
    <div id="containera"></div>
    <div id="notification" class="alert alert-success notification-item"></div>
    <div class="container">
        <p>Copyright © 2019 Sho Sato. All Rights Reserved. shosatojp2001@gmail.com</p>
    </div>
    <template id="image-item-template">
        <div class="item">
            <div class="item-img">
                <img class="" src="" height="200px" width="auto" style="object-fit: contain;">
            </div>
            <div class="img-size"></div>
        </div>
    </template>
    <script>
        //notification
        const notification = document.querySelector('#notification');
        var currentNotification;

        function openNotification(msg) {
            if (currentNotification) {
                clearTimeout(currentNotification);
                closeNotification();
            }
            notification.textContent = msg;
            notification.style.display = 'block';
            currentNotification = setTimeout(closeNotification, 1000);
        }

        function closeNotification() {
            notification.style.display = 'none';
        }

        //scroll bottom to reload
        var ScrollEventFlag = false;
        document.body.onscroll = async function () {
            if ((window.scrollY + window.innerHeight + 300 > document.body.scrollHeight) && !ScrollEventFlag) {
                ScrollEventFlag = true;
                await listImages(images_index, LOAD_COUNT);
                ScrollEventFlag = false;
            }
        }

        //load form values and fill chrome cache dir.
        loadForm();
        (async function () {
            const cache_dir = document.querySelector('#cache-dir');
            if (!cache_dir.value)
                cache_dir.value = (await findChromeCacheDir()) || '';
        })();

        //realign items when window resizes.
        window.onresize = function () {
            LAST_ALIGNED_ITEM_INDEX = -1;
            alignItems();
        };

        //onbeforeunloadにexportFunctionした関数を指定するとなぜかnodejsプロセスが終わってくれる。。。
        //これがないとnodejsプロセスが残る。
        window.onbeforeunload = exit;

    </script>
</body>

</html>